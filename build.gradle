buildscript {
    repositories {
        mavenLocal()
        mavenCentral()
        maven { url "http://maven.restlet.org" }
    }

    dependencies {
        classpath group: 'com.xmlcalabash', name: 'xmlcalabash1-gradle', version: '1.3.5'
    }
}

plugins {
    id 'base'
}
apply plugin: 'com.xmlcalabash.task'

import com.xmlcalabash.XMLCalabashTask

if (rootProject != project) { project.buildDir = rootProject.buildDir }
project.ext.pathsxml = new File(project.buildDir, 'paths.xml')

task setupPaths { doLast {
    project.ext.dataDir = project.hasProperty('dataDir')? project.file(dataDir) : rootProject.file('data/xml')
    if (!dataDir.exists()) {
       throw new FileNotFoundException("Source folder $dataDir not found")
    }
    project.buildDir.mkdirs()
    def sourceURL = dataDir.toURL()
    def buildURL = buildDir.toURL()
    pathsxml.write("""<?xml version="1.0" encoding="UTF-8"?>
<!-- This file has been generated from the Gradle build -->
<configuration xmlns="http://www.faustedition.net/ns">
  <source>$sourceURL</source>
  <builddir>$buildURL</builddir>
</configuration>""")
    logger.warn("Wrote $pathsxml")
}}

task generateAll(type: XMLCalabashTask) {
    dependsOn setupPaths
    pipeline 'generate-all.xpl'
    option 'paths', pathsxml.toURL().toString()
}

assemble.dependsOn(generateAll)
